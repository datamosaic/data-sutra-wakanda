/** * Default entry point */function controller(request, response) {	var path = request.urlPath.split('/');	if (path.length) {		path.splice(0,1);	}			// should have been caught by home page	if (path.length == 1 && path[0] == '') {		return Router.homePage(request,response);	}		return Router.project(path,request,response);}/** * RPC entry point */// function rpc(request, response) {// 	return Router.rpc(request,response);// }/** * Theme-specific entry point */function theme(request, response) {	return Router.themes(request,response);}/** * Home page */function home(request, response) {	return Router.homePage(request,response);}/** * Error page */function error(request, response) {	return Router.error(request,response);}// require in librariesvar thisSolution = application.getSettingFile('resources').parent.parent.path;var registry = require( thisSolution + 'Security/Kabootit/Security/registry.js' );var MIME = require(thisSolution + 'Resources/Modules/mimeTypes.js');// name of folder flagged as webfoldervar projFile, webFolder;application.getSettingFile('resources').parent.forEachFile(function(item, iterator, parent) {	if (item.extension == 'waProject') {		projFile = item;	}})var project = JSON.parse(XmlToJSON(projFile.toString(), "json-bag", "project"));for (var i = 0; i < project.folder.length; i++) {	if (project.folder[i].path && project.folder[i].tag[0].name == 'webFolder') {		webFolder = project.folder[i].path;	}}if (webFolder.length) {	webFolder = webFolder.substring(2,webFolder.length - 1);}else {	webFolder = 'WebFolder'}/** * Router config */var Router = (function() {	return {		/**		 * Project RPC calls		 * @param {HTTPRequest} request		 * @param {HTTPResponse} response		 */		rpc : function(request,response) {			debugger			response.headers.location = '/rpc';			response.statusCode = 307;			debugger		},				/**		 * Project pages		 * @param {Array} params		 * @param {HTTPRequest} request		 * @param {HTTPResponse} response		 */		project : function(params,request,response) {						if (!params) {				params = new Array()			}						// TODO: error checking			var routes = registry.routes(params[0].toLowerCase(),request.host);			var basePath = FileSystemSync("PROJECT").path + webFolder + '/';						// check for symlinked top-level directory			var topLevelSymlink = Folder(basePath + params[0]);			if (topLevelSymlink.exists && topLevelSymlink.parent.path != basePath) {				basePath = topLevelSymlink.parent.path + webFolder + '/'			}						// get requested file (remove trailing slash)			var fileName = params.join('/');			if (fileName[fileName.length - 1] == '/') {				fileName = fileName.slice(0,fileName.length - 1);				params.pop();			}			var pageName = fileName;						// handle case where index			if (!fileName) {				fileName = 'index';			}						// we're finally visiting the initially requested page, remove from storage			if (currentSession().storage.pageRequested == fileName) {				delete currentSession().storage.pageRequested;			}						// do we have access to this file			var accessAllowed = false;			routes.all.some(function check(elem, idx, array) {				// partial match				if (elem.toLowerCase() == fileName.toLowerCase().substr(0,elem.length) || elem == '*') {					accessAllowed = true;					return true;				}				return false;			});						// requested resource			if (accessAllowed) {				// redirect to login page if...				if (// not logged in					currentSession().user.name == 'default guest' && 					// this isn't the login page					fileName.substr(0,5) != 'login' && 					// not on the whitelist					(routes.noLogin.length ? routes.noLogin.filter(function(item){return fileName.indexOf(item) != 0}).length : true) && 					// whitelist doesn't allow all through					routes.noLogin.indexOf('*') == -1				) {					// store what page trying to access					if (!currentSession().storage.pageRequested) {						currentSession().storage.pageRequested = fileName;					}										return this.login(request,response);				}								// grab file from filesystem and return appropriately				var fullPath = basePath + fileName;				var resource = File(fullPath);								// if this resource doesn't exist, check to make sure it isn't a wakanda page				var cnt = 0;				while (!resource.exists && cnt < params.length) {					function testWakSlot(slot,position) {						testPath += slot;												if (position == cnt) {							testPath += '.waPage';						}												if (position != params.length - 1) {							testPath += '/';						}					}										var testPath = '';					params.forEach(testWakSlot);					resource = File(basePath + testPath);										// make sure get out of loop if resource really doesn't exist					cnt++;				}								// if requesting main page, try looking inside .waPage folder				if (!resource.exists) {					resource = File(fullPath + '.waPage/index.html');					var wakPage = resource.exists;				}				if (!resource.exists) {					resource = File(fullPath + '/index.html');				}										if (resource.exists) {					// this is home page...only serve from /					if (registry.homePage(request.host) == pageName) {						try {							response.headers.location = '/';							response.statusCode = 308;							return;						}						catch (e) {											}					}										// redirect to page ending in slash (so waf-builder files are always available)					if ((resource.extension == 'html' || resource.extension == 'htm') && wakPage && request.urlPath[request.urlPath.length - 1] != '/') {						try {							response.headers.location = request.urlPath + '/';							response.statusCode = 308;						}						catch (e) {											}					}										// look up extension and set MIME type appropriately					if (MIME.exists('.' + resource.extension)) {						response.contentType = MIME.get('.' + resource.extension);					}									try {						return resource.toString();					}					catch (e) {						try {							return resource.toBuffer().toBlob();						}						catch (e) {												}					}				}			}						// default 404 error			return this.error();		},				/**		 * Project Theme resources (not currently in use)		 * @param {HTTPRequest} request		 * @param {HTTPResponse} response		 */		themes : function(request,response) {			var params = request.urlPath.split('/');//			params.splice(0,2);			// get rid of everything up until themes			params.splice(0,params.indexOf('themes') + 1);			if (!params) {				params = new Array()			}						// get theme directory			var modelPath = ds.getModelFolder().path;			var themePath = modelPath.split('/');			themePath.splice(themePath.length - 2,2);			themePath = themePath.join('/');			themePath += '/Themes/Themes/';						// get requested file			var fileName = params.join('/');			var resource = File(themePath + fileName);			if (resource.exists) {				// look up extension and set MIME type appropriately				if (MIME.exists('.' + resource.extension)) {					response.contentType = MIME.get('.' + resource.extension);				}								try {					return resource.toString();				}				catch (e) {					try {						return resource.toBuffer().toBlob();					}					catch (e) {											}				}			}						// default 404 error			return this.error();		},				/**		 * Project login page		 * @param {HTTPRequest} request		 * @param {HTTPResponse} response		 */		login : function(request,response) {			var path = request.urlPath.split('/');			path.splice(0,2);						// check for location of "home.waPage" in this project and serve it up by default			var resource = File(ds.getModelFolder().path + 'login.txt');						// hand coded login page			if (resource.exists) {				var path = resource.toString();			}			// hard coded login page (default)			else {				path = 'login';			}						if (File(ds.getModelFolder().path + webFolder + '/' + path).exists || Folder(ds.getModelFolder().path + webFolder + '/' + path).exists || Folder(ds.getModelFolder().path + webFolder + '/' + path + '.waPage').exists) {				try {					response.headers.location = '/' + path + '/';					response.statusCode = 307;					// response.contentType = 'text/html'					// return resource.toString();				}				catch (e) {									}			}						return '404'		},				/**		 * Project Error page		 * @param {HTTPRequest} request		 * @param {HTTPResponse} response		 */		error : function(request,response) {			return '404'		},				/**		 * Project Home page (TODO: need to pull through resources a bit better)		 * @param {HTTPRequest} request		 * @param {HTTPResponse} response		 */		homePage : function(request,response) {			var path = request.urlPath.split('/');			path.splice(0,2);						// TODO: error checking			var homePage = registry.homePage(request.host);						// check for designation of home page in Security json			if (homePage) {				// it is possible to pass in a fully qualified wakanda page as the homePage name and therefore not trigger wakPage				var staticFile = File(ds.getModelFolder().path + webFolder + '/' + homePage);				var staticFolder = Folder(ds.getModelFolder().path + webFolder + '/' + homePage);				var wakPage = Folder(ds.getModelFolder().path + webFolder + '/' + homePage + '.waPage');								if (staticFile.exists || staticFolder.exists || wakPage.exists) {					var noLoginRequired = registry.routes(null,request.host).noLogin;										// not logged in and login required for this page, show log in page					if (currentSession().user.name == 'default guest' && 						// this isn't the login page						homePage.substr(0,5) != 'login' && 						// this page isn't in whitelist						noLoginRequired.indexOf(homePage) == -1 &&						// all pages aren't whitelisted						noLoginRequired.indexOf('*') == -1) {												// store what page trying to access						currentSession().storage.pageRequested = homePage;						return this.login(request,response);					}										try {						// this is a wakanda page						if (wakPage.exists) {							var resource = File(ds.getModelFolder().path + webFolder + '/' + homePage + '.waPage/index.html');													}						// static page						else {							var resource = File(ds.getModelFolder().path + webFolder + '/' + homePage);						}												// serve page up from /						if (resource.exists) {							// look up extension and set MIME type appropriately							if (MIME.exists('.' + resource.extension)) {								response.contentType = MIME.get('.' + resource.extension);							}										try {								var html = resource.toString();															// modify packageJson to look in correct location of the home page								if (wakPage.exists) {									var index = html.search(/<meta name="WAF.packageJson"(?:\s)?\/>/gi);									// packageJson not specified									if (index != -1) {										// 28 is length of meta name blah blah										index += 28;										html = html.substring(0,index) + ' content="/' + homePage + '.waPage/index.package.json"' + html.substring(index, html.length);									}								}																return html							}							catch (e) {								try {									return resource.toBuffer().toBlob();								}								catch (e) {													}							}						}						// non-wakanda pages get served from default location						else {							response.headers.location = '/' + homePage + '/';							response.statusCode = 307;						}					}					catch (e) {										}				}			}						return '127.0.0.1';		}	}})();// requiredvar module = module || new Object()if (module && module.exports) {	module.exports = Router;}